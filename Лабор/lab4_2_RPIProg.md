**Програмна інженерія в системах управління. Лабораторний практикум.** Автор і лектор: Олександр Пупена 

| [<- до лаборних робіт](README.md)  | [на основну сторінку курсу](../README.md) |
| ---------------------------------- | ----------------------------------------- |
| [<-1 частина](lab4_1_RPIConfig.md) |                                           |

#  Лабораторна робота №4.    Основи роботи з Raspberry PI3

Рекомендується попередньо ознайомитися з матеріалами лекції по RPI за [посиланням](../Лекц/RaspberryPi.md).

## 2. Основи проектування, розробки та документація систем на базі Raspberry Pi з використанням GPIO.

Перелік апаратних засобів, необхідних для лабораторної роботи. 

| Найменування                           | Кількість | Примітка |
| -------------------------------------- | --------- | -------- |
| Raspberry PI                           | 1         | У комплекті з блоком живлення та картою пам'яті |
| Макетна плата 170                      | 1         | або аналогічна                                  |
| Ультразвуковий датчик відстані HC-SR04 | 1         |                                                 |
| Датчик температури на 1-Wire DS18B20   | 1         |                                                 |
| Світлодіод                             | 1         |                                                 |
| Резистор 1 кОм                         | 1         |                                                 |
| Резистор 10 кОм                        | 1         |                                                 |
| Провід dupont (мама-тато)              | 6         | бажано 2 чорні, червоний, зелений і білий       |

### Проектування з використанням Fritzing

###### 2.1. Завантаження Fritzing.

Завантажте на ПК безкоштовну бета-версію середовища проектування Fritzing [за даним посиланням](https://www.electroschematics.com/fritzing-software-download/) або офіційну платну версію [з офіційного сайту](https://fritzing.org/download/) 

###### 2.2. Завантаження бібліотеки зображень RPI3.

Завантажте на ПК бібліотеку RPI3 з іменем `Raspberry Pi 3_3.fzpz` для  Fritzing  за [посиалнням](https://fritzing.org/media/fritzing-repo/projects/r/raspberry-pi-3/fritzing/Raspberry Pi 3_3.fzpz). Обговорення бібліотеки на форумі доступне за [посиланням ](https://fritzing.org/projects/raspberry-pi-3) 

###### 2.3. Запуск, налаштування Fritzing та встановлення бібліотеки RPI3.

Розпакуйте архів та запустіть `Fritzing.exe`. Імпортуйте файл з іменем `Raspberry Pi 3_3.fzpz` з панелі `Parts`, як це показано на рисунку

![](RPIMedia/18.png)

Через меню `Edit->Prefernces` Ви можете вибрати найзручнішу для Вас мову інтерфейсу 

###### 2.4. Розміщення елементів на платі для схеми керування діодом.

Активуйте режим відображення макетної плати через меню`View->Show BreadBoard`, або натиснувши відповідну вкладку. На панелі Parts перейдіть в розділ Mine, перенесіть туди RPI3

![](RPIMedia/19.png)

У розділі `CORE` панелі інструментів `Parts` виберіть два елементи:

- `Basic -> Resistor` 

- `Output -> RED LED`

  ![](RPIMedia/20.png)

У налаштуваннях резистора вкажіть опір 1 Ком (Resistance = 1kΩ).

###### 2.5. Реалізація схеми підключення .

Перейдіть на вкладку Shematic  `View->Show Schematic`, або натиснувши відповідну вкладку. Розмістіть на схемі елементи, щоб схема була більш читабельною, використовуючи команди з контекстного меню  `Flip vertical`, `Rotate` і т.п. З'єднайте елементи на схемі, як показано на рисунку.

 ![](RPIMedia/21.png) 

У налаштуванні провідників виберіть колір, для підключення `GPIO4` до `LED1` - червоний, для підключення `R1` до `GND` - чорний.

###### 2.6. Коригування схеми підключення на платі . 

Перейдіть на режим відображення макетної плати. З'єднайте контакти, які обозначені пунктиром. Змініть кольори провідників. 

![](RPIMedia/22.png)

Використовуючи `Edit -> Add Note` добавте коментар до схеми `Схема Прізвище Ім''я`, де вкажіть своє прізвище.  

###### 2.7. Збереження проекту та експорт схем

Збережіть файл проекту з іменем `Diod_Name`, де замість Name вкажіть своє прізвище латинськими літерами.  

У папці проекту Git, яка була створена для лабораторної роботи 3, що має зв'язок з GitHub (наприклад `C:\Users\username\.node-red\projects\project1`) , створіть папку `Lab4` а в ній папку `Schemas`. 

Експортуйте у папку `Lab4` кілька файлів з проекту:

- перемкніть на панель макетної плати `Breadboard` та експортуйте список деталей `File -> Export -> List of Parts`
- та експортуйте схему у вигляді PNG `File -> Export -> as Image -> PNG... `
- перемкніть на панель схеми `Schematic` та експортуйте схему у вигляді PNG `File -> Export -> as Image -> PNG... `

### Реалізація та перевірка: підключення та керування діодом

###### 2.8. Збірка та перевірка схеми. 

Вимкніть Raspberry PI, якщо він включений.

Подивіться уважно на реальне розміщення контактів GPIO:

![](RPIMedia/26.jpg) 

![](RPIMedia/27.png)

Попросіть у викладача необхідні елементи, та підключіть їх, відповідно до розробленої схеми. Уважно перевірте підключення.

 ![](RPIMedia/23.jpg)

###### 2.9. Перевірка схеми викладачем.

Покличте викладача, щоб він перевірив схему. Якщо схема одобрена, перейдіть до наступного пункту. 

###### 2.10. Увімкнення та первинні налаштування RPI.

Увімкніть RPI.  За допомогою VNC зайдіть на робочий стіл RPI. 

Зайдіть в меню `Налаштування -> Raspberry Pi Configuration` і на вкладці `Interfaces` активуйте Remote GPIO.

![](RPIMedia/23.png)   

###### 2.10.1. Ручний запуск Node-RED.

Для запуску Node-RED на RPI3 використовується команда у вікні терміналу 

```bash
node-red-start
```

Якщо закрити вікно терміналу (або натиснути Ctrl + C), то Node-RED все одно продовжить працювати, але в фоновому режимі. Щоб зупинити Node-RED, запустіть команду 

```bash
node-red-stop
```

Також Node-RED припинить свою роботу після перезавантаження RPI3.

![](RPIMedia/31.png)

Щоб відкрити вікно редактора в браузері необхідно прописати IP-адресу та номер порту 127.0.0.1:1880.

![](RPIMedia/32.png)



###### 2.10.2. Автоматичний запуск Node-RED.

Автозапуск Node-RED краще робити за допомогою вбудованого демона systemd. Попередньо встановлена версія робить це за допомогою файлу «nodered.service», а також за допомогою скриптів запуску і зупинки. Їх можна встановити за допомогою наступних команд:

```bash
sudo wget https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/nodered.service -O /lib/systemd/system/nodered.service
sudo wget https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/node-red-start -O /usr/bin/node-red-start
sudo wget https://raw.githubusercontent.com/node-red/raspbian-deb-package/master/resources/node-red-stop -O /usr/bin/node-red-stop
sudo chmod +x /usr/bin/node-red-st*
sudo systemctl daemon-reload
```

Ці команди запускаються користувачем `root` (`sudo`). Вони завантажують три файли , роблять два скрипта виконуваними, а потім перезавантажують демона systemd. 

Далі, щоб налаштувати автозапуск Node-RED при кожному завантаженні виконайте команду:

```bash
sudo systemctl enable nodered.service
```


Відключити автозапуск можна за допомогою такої команди:

```bash
sudo systemctl disable nodered.service
```

Перезавантажте RPI3 і переконайтесь що Node-RED запускається автоматично при старті системи. Якщо ні повторіть попередні пункти.

###### 2.11. Створення програми та перевірка програми для Node-RED.

Зайдіть на сторінку програмування Node-RED на RPI3. Створіть програму для керування діодом.

![](RPIMedia/24.png) 

Перевірте роботу програми  натискаючи `Inject TRUE` а потім `Inject FALSE`

###### 2.12. Вивід кнопок включення/виключення на Веб-інтерфейс

Встановіть бібліотеку `node-red-dashboard` , якщо вона ще не була встановлена.

Самостійно реалізуйте керування кнопками вкл/откл з графічного Веб-інтерфейсу.

### Розробка документації .

###### 2.13. Збереження вигляду та коду програми користувача.

Зробіть копію екрану програми. Використовуючи графічний редактор виріжіть робочу частину програми і збережіть в форматі PNG на ПК в папці  проекту`Lab4`. 

Зробіть експорт потоку як форматований JSON та завантажте через кнопку Download. Збережіть в папці проекту  `Lab4` з назвою `diod.json`.

![](RPIMedia/25.png)

###### 2.14. Завантаження та встановлення Typora (або аналогічного). 

Завантажте та встановіть MarkDown редактор Typora або аналогічний.

-  завантажте редактор (Typora [для Windows](https://typora.io/#windows)) 

- встановіть редактор

###### 2.15. Створення файлу README.MD 

У папці проекту `Lab4`на ПК створіть файл з назвою README.MD. Зміст файлів, які так називаються автоматично відображаються в GitHub. Цей файл буде звітом з лабораторної роботи.

###### 2.16. Оформлення лабораторної роботи.

Повторіть матеріал [лекції](../Лекц/MarkDown.md) по MarkDown.

Відкрийте [приклад](RPIMedia\Example\README.MD) оформлення лабораторної роботи та зробіть аналогічне оформлення для зробленої частини.

###### 2.17. Завантаження матеріалів на GitHub.

Зробіть коміт та завантажте (push) проект на GitHub. 

Зайдіть на GitHub в репозиторій проекту. Зайдіть в папку Lab4, там повинен відображатися Ваш звіт. Перевірте, що він дійсно відображається коректно. 

За необхідності зробіть виправлення та повторіть коміт та завантаження до GitHub.   


### Використання датчика відстані.

Нижче наводяться кроки для підключення ультразвукового датчика відстані HC-SR04, та його використання в Node-RED.

###### 2.18. Підключення датчика відстані до RPI.

Вимкніть живлення Raspberry PI. 

Зберіть нову схему, як показано на рисунку. Уважно перевірте правильність.

![](RPIMedia/28.png)

**Зверніть особливу увагу на найменування контактів підключення ультразвукового датчика відстані. На монтажній схемі він зображений повернуто до плати, по факту його зручніше розміщувати повернуто від плати.**

Контакти датчика відстані підключені до контактів RPI:

| RPI             | Датчики HC-SR04 |
| --------------- | --------------- |
| +5V (pin 2)     | Vcc             |
| GPIO27 (pin 13) | Trig            |
| GPIO17 (pin 11) | Echo            |
| Gnd (pin 9)     | Gnd             |

![](RPIMedia/29.png)



Попросіть викладача перевірити схему і у випадку підтвердження правильності, переходьте до виконання наступного пункту. 

###### 2.19. Встановлення бібліотеки node-red-node-pisrf.

У node-RED для RPI встановіть бібліотеку node-red для роботи з ультразвуковим датчиком: **node-red-node-pisrf**

###### 2.20. Створення та перевірка програми користувача

Видаліть старий фрагмент програми керування світлодіодом.

Використовуючи вузол `rpi srf` з розділу інструментів `Raspberry PI` реалізуйте програму, показану на рисунку:

![](RPIMedia/30.png)

Зробіть розгортання проекту та первірте роботу. 

Активувавши вузол **Debug** можна побачити данні які йдуть від датчика відстані. 

###### 2.21. Виведення на Веб-інтерфейс.

Виведіть значення на Веб-інтерфейс, використовуючи `dashboard` . Проаналізуйте в яких одиницях показує значення відстані. 

###### 2.22. Керування яскравістю світлодіода в залежності від відстані до об'єкта 

Створіть програму, яка показана на рисунку.



![img](RPIMedia/3.png)

Ця програма керує яскравістю свічення світлодіоду в залежності від відстані до об'єкту. Від 1 метру тьмяне світіння, чим ближче, тим яскравіше.

Зробіть розгортання, підводячи якийсь предмет до датчика наближення перевірте роботу програми.   

###### 2.23. Фіксація у папці проекту 

- Зробіть копію екрану програми. Використовуючи графічний редактор виріжіть робочу частину програми і збережіть в форматі PNG на ПК в папці  проекту`Lab4` під назвою `Usonic.png`. 

- Зробіть експорт потоку як форматований JSON та завантажте через кнопку Download. Збережіть в папці проекту  `Lab4` з назвою `Usonic.json`. 
- Зробіть оформлення у файлі README.md, який Ви редагували до цього.
- Зробіть коміт та завантажте (push) проект на GitHub. 
- Зайдіть на GitHub в репозиторій проекту. Зайдіть в папку Lab4, там повинен відображатися Ваш змінений звіт. Перевірте, що він дійсно відображається коректно. 
- За необхідності зробіть виправлення та повторіть коміт та завантаження до GitHub.    

### Підключення датчика температури по 1-Wire.

###### 2.14. Підготовка RPI.

- Видаліть стару програму на RPI.
- Вимкніть живлення Raspberry PI.  
- Відключіть усі проводи з попередньої частини роботи.

###### 2.15. Активування 1-Wire на RPI.

- Увімкніть живлення на RPI. 
- Зайдіть через VNC на робочий стіл RPI та через налаштування активуйте 1-Wire інтерфейс.

![img](RPIMedia/4.png)

- Вимкніть живлення Raspberry PI.

###### 2.16. Підключення датчика температури до RPI через 1-Wire.

Підключіть датчик температури відповідно до вказаної схеми.

Зверніть увагу, що використовується живлення 3,3 В а резистор номіналом 10 кОм.

![img](RPIMedia/8.png)

###### 2.17. Встановлення бібліотеки node-red-contrib-sensor-ds18b20

- Увімкніть RPI. 
- Інсталюйте в node-red потрібну бібліотеку: `node-red-contrib-sensor-ds18b20` Ця бібліотека спрощує роботу з датчиками температури `ds18b20`
- перезавантажте систему

###### 2.18. Створення та перевірка програми користувача.

- Створіть програму, наведену на рисунку.  Ідентифікатор датчика температури вибирається зі списку (повинен знайтися автоматично) .

![img](RPIMedia/7.png)

- Зробіть розгортання та перевірте її роботу.


###### 2.19. Дооформлення роботи.

Оформіть дану частину аналогічно як в п.2.23. 

[<-1 частина](lab4_1_RPIConfig.md)